<!DOCTYPE html>
<html>
<head>
    <title>CSV Import Debug Test</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>CSV Import Debug Test</h2>
        
        <button type="button" class="btn btn-primary" onclick="document.getElementById('csvUpload').click()">
            Import CSV File
        </button>
        
        <input type="file" id="csvUpload" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">
        
        <div id="importStatus" class="alert alert-info mt-3" style="display: none;"></div>
        
        <div id="results" class="mt-3"></div>
    </div>

    <script>
        // Mock campaign users array
        let campaignUsers = [];
        
        function addCampaignUser(username, user_id, phone, priority = 1) {
            console.log('Adding user:', {username, user_id, phone, priority});
            const user = {
                id: Date.now(),
                username: username,
                user_id: user_id,
                phone: phone,
                priority: priority
            };
            
            campaignUsers.push(user);
            updateResults();
        }
        
        function updateResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h4>Imported Users (${campaignUsers.length}):</h4>
                <pre>${JSON.stringify(campaignUsers, null, 2)}</pre>
            `;
        }
        
        function handleFileImport(event) {
            console.log('handleFileImport called', event);
            
            const file = event.target.files[0];
            console.log('Selected file:', file);
            
            if (!file) {
                console.error('No file selected');
                return;
            }
            
            const status = document.getElementById('importStatus');
            status.style.display = 'block';
            status.className = 'alert alert-info mt-3';
            status.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
            
            console.log('Starting to read file...');
            
            // Read CSV file
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('File read complete');
                try {
                    const content = e.target.result;
                    console.log('File content:', content.substring(0, 200) + '...');
                    
                    const lines = content.split('\n');
                    console.log('Lines found:', lines.length);
                    
                    let imported = 0;
                    
                    // Skip header line (expecting: User name, User ID, Phone number)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        console.log('Processing line:', line);
                        
                        const columns = line.split(',');
                        const username = columns[0]?.trim(); // User name
                        const user_id = columns[1]?.trim(); // User ID
                        const phone = columns[2]?.trim(); // Phone number
                        
                        console.log('Parsed columns:', {username, user_id, phone});
                        
                        // Clean username (remove @ if present)
                        const cleanUsername = username ? username.replace('@', '').replace(/^@/, '') : '';
                        
                        if (cleanUsername || user_id || phone) {
                            addCampaignUser(cleanUsername, user_id, phone, 1);
                            imported++;
                        }
                    }
                    
                    status.className = 'alert alert-success mt-3';
                    status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users successfully!`;
                    
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    status.className = 'alert alert-danger mt-3';
                    status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading file: ${error.message}`;
                }
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                status.className = 'alert alert-danger mt-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading file: ${error}`;
            };
            
            console.log('Starting readAsText...');
            reader.readAsText(file);
        }
        
        console.log('Debug script loaded');
    </script>
</body>
</html>
function handleFileImport(event) {
    console.log("File upload function called", event);
    const file = event.target.files[0];
    console.log("Selected file:", file);
    if (!file) return;
    
    const status = document.getElementById('importStatus');
    status.style.display = 'block';
    status.className = 'alert alert-info m-3';
    status.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    const fileName = file.name.toLowerCase();
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
    
    if (isExcel) {
        // Handle Excel files using SheetJS
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                console.log("Reading Excel file...");
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Get first worksheet
                const wsname = workbook.SheetNames[0];
                const ws = workbook.Sheets[wsname];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});
                console.log("Excel data:", jsonData);
                
                let imported = 0;
                
                // Skip header row (expecting: User name, User ID, Phone number)
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                    
                    const username = row[0] ? String(row[0]).trim() : '';
                    const user_id = row[1] ? String(row[1]).trim() : '';
                    const phone = row[2] ? String(row[2]).trim() : '';
                    
                    console.log('Processing Excel row:', {username, user_id, phone});
                    
                    // Clean username (remove @ if present)
                    const cleanUsername = username ? username.replace(/@+/g, '') : '';
                    
                    if (cleanUsername || user_id || phone) {
                        addCampaignUser(cleanUsername, user_id, phone, 1);
                        imported++;
                    }
                }
                
                status.className = 'alert alert-success m-3';
                status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users from Excel successfully!`;
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Excel processing error:', error);
                status.className = 'alert alert-danger m-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading Excel file: ${error.message}`;
            }
        };
        
        reader.onerror = function(error) {
            console.error("FileReader error:", error);
            status.className = 'alert alert-danger m-3';
            status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading Excel file: ${error}`;
        };
        
        console.log("FileReader started for Excel");
        reader.readAsArrayBuffer(file);
        
    } else {
        // Handle CSV files
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                console.log("Reading CSV file...");
                const lines = e.target.result.split('\n');
                let imported = 0;
                
                // Skip header line (expecting: User name, User ID, Phone number)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const columns = line.split(',');
                    const username = columns[0]?.trim(); // User name
                    const user_id = columns[1]?.trim(); // User ID
                    const phone = columns[2]?.trim(); // Phone number
                    
                    console.log('Processing CSV row:', {username, user_id, phone});
                    
                    // Clean username (remove @ if present)
                    const cleanUsername = username ? username.replace(/@+/g, '') : '';
                    
                    if (cleanUsername || user_id || phone) {
                        addCampaignUser(cleanUsername, user_id, phone, 1);
                        imported++;
                    }
                }
                
                status.className = 'alert alert-success m-3';
                status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users from CSV successfully!`;
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('CSV processing error:', error);
                status.className = 'alert alert-danger m-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading CSV file: ${error.message}`;
            }
        };
        
        reader.onerror = function(error) {
            console.error("FileReader error:", error);
            status.className = 'alert alert-danger m-3';
            status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading CSV file: ${error}`;
        };
        
        console.log("FileReader started for CSV");
        reader.readAsText(file);
    }
}
