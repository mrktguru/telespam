<!DOCTYPE html>
<html>
<head>
    <title>CSV Import Debug Test</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>CSV Import Debug Test</h2>
        
        <button type="button" class="btn btn-primary" onclick="document.getElementById('csvUpload').click()">
            Import CSV File
        </button>
        
        <input type="file" id="csvUpload" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleCampaignCSVUpload(event)">
        
        <div id="importStatus" class="alert alert-info mt-3" style="display: none;"></div>
        
        <div id="results" class="mt-3"></div>
    </div>

    <script>
        // Mock campaign users array
        let campaignUsers = [];
        
        function addCampaignUser(username, user_id, phone, priority = 1) {
            console.log('Adding user:', {username, user_id, phone, priority});
            const user = {
                id: Date.now(),
                username: username,
                user_id: user_id,
                phone: phone,
                priority: priority
            };
            
            campaignUsers.push(user);
            updateResults();
        }
        
        function updateResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h4>Imported Users (${campaignUsers.length}):</h4>
                <pre>${JSON.stringify(campaignUsers, null, 2)}</pre>
            `;
        }
        
        function handleCampaignCSVUpload(event) {
            console.log('handleCampaignCSVUpload called', event);
            
            const file = event.target.files[0];
            console.log('Selected file:', file);
            
            if (!file) {
                console.error('No file selected');
                return;
            }
            
            const status = document.getElementById('importStatus');
            status.style.display = 'block';
            status.className = 'alert alert-info mt-3';
            status.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
            
            console.log('Starting to read file...');
            
            // Read CSV file
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('File read complete');
                try {
                    const content = e.target.result;
                    console.log('File content:', content.substring(0, 200) + '...');
                    
                    const lines = content.split('\n');
                    console.log('Lines found:', lines.length);
                    
                    let imported = 0;
                    
                    // Skip header line (expecting: User name, User ID, Phone number)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        console.log('Processing line:', line);
                        
                        const columns = line.split(',');
                        const username = columns[0]?.trim(); // User name
                        const user_id = columns[1]?.trim(); // User ID
                        const phone = columns[2]?.trim(); // Phone number
                        
                        console.log('Parsed columns:', {username, user_id, phone});
                        
                        // Clean username (remove @ if present)
                        const cleanUsername = username ? username.replace('@', '').replace(/^@/, '') : '';
                        
                        if (cleanUsername || user_id || phone) {
                            addCampaignUser(cleanUsername, user_id, phone, 1);
                            imported++;
                        }
                    }
                    
                    status.className = 'alert alert-success mt-3';
                    status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users successfully!`;
                    
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    status.className = 'alert alert-danger mt-3';
                    status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading file: ${error.message}`;
                }
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                status.className = 'alert alert-danger mt-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading file: ${error}`;
            };
            
            console.log('Starting readAsText...');
            reader.readAsText(file);
        }
        
        console.log('Debug script loaded');
    </script>
</body>
</html>
