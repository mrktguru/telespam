#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "=========================================="
echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "=========================================="
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_DIR"

echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_DIR"
echo ""

# –®–ê–ì 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
echo "üîÑ –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git fetch origin
git checkout fix/csv-upload-campaign 2>/dev/null || echo "–£–∂–µ –Ω–∞ –≤–µ—Ç–∫–µ fix/csv-upload-campaign"
git pull origin fix/csv-upload-campaign
echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω"
echo ""

# –®–ê–ì 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üîß –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ -f "fix_db_permissions.sh" ]; then
    sudo bash fix_db_permissions.sh
else
    echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç fix_db_permissions.sh –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø—Ä–∞–≤–ª—è—é –≤—Ä—É—á–Ω—É—é..."
    DB_FILE="${PROJECT_DIR}/telespam.db"
    if [ -f "$DB_FILE" ]; then
        sudo chmod 664 "$DB_FILE"
        GUNICORN_USER=$(systemctl show -p User telespam-web.service 2>/dev/null | cut -d= -f2 || echo "root")
        sudo chown "$GUNICORN_USER:$GUNICORN_USER" "$DB_FILE"
        echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"
    else
        echo "‚ö†Ô∏è  –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω: $DB_FILE"
    fi
fi
echo ""

# –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
echo "üìÅ –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤..."
sudo mkdir -p uploads/accounts
sudo chmod 755 uploads
sudo chmod 755 uploads/accounts
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"
echo ""

# –®–ê–ì 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
echo "üîÑ –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ telespam-web..."
sudo systemctl restart telespam-web
sleep 2  # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
echo "‚úÖ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
echo ""

# –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl status telespam-web --no-pager -l
echo ""

# –®–ê–ì 6: –ü–æ–∫–∞–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤
echo "üìã –®–∞–≥ 6: –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
echo "----------------------------------------"
sudo journalctl -u telespam-web -n 20 --no-pager
echo "----------------------------------------"
echo ""

echo "=========================================="
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
echo "=========================================="
echo ""
echo "–ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
echo "  sudo journalctl -u telespam-web -f"
echo ""

