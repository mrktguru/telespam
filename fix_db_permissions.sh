#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite

echo "=========================================="
echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
echo "=========================================="
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É (—Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DB_PATH="${PROJECT_DIR}/telespam.db"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –ë–î
if [ ! -f "$DB_PATH" ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω: $DB_PATH"
    echo "–°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π —Ñ–∞–π–ª..."
    touch "$DB_PATH"
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è gunicorn –∏–∑ systemd service
GUNICORN_USER=$(systemctl show -p User telespam-web.service 2>/dev/null | cut -d= -f2)

if [ -z "$GUNICORN_USER" ]; then
    # –ü—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞
    GUNICORN_USER=$(ps aux | grep gunicorn | grep -v grep | head -1 | awk '{print $1}')
fi

if [ -z "$GUNICORN_USER" ]; then
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è gunicorn, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    GUNICORN_USER=$(whoami)
fi

echo "üìÅ –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: $DB_PATH"
echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å gunicorn: $GUNICORN_USER"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞
echo "–¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞:"
ls -la "$DB_PATH" 2>/dev/null || echo "–§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
echo ""

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª –ë–î
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
sudo chmod 664 "$DB_PATH"
sudo chown "$GUNICORN_USER:$GUNICORN_USER" "$DB_PATH"

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
sudo chmod 755 "$(dirname "$DB_PATH")"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "‚úÖ –ù–æ–≤—ã–µ –ø—Ä–∞–≤–∞:"
ls -la "$DB_PATH"
echo ""

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å telespam-web..."
sudo systemctl restart telespam-web

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
echo "   sudo journalctl -u telespam-web -f"
echo ""

