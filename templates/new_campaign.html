{% extends "base.html" %}

{% block title %}New Campaign - Telegram Outreach{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Create New Campaign</h1>
    <a href="{{ url_for('campaigns') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</div>
<div class="alert alert-warning mb-3" role="alert">
    <strong>üöÄ Version 2.0 - Build 20241130_142500</strong><br>
    <small>‚úÖ If you see this yellow box, the page has been updated!<br>
    üìã Check browser console (F12) for detailed import logs.</small>
</div>

<form method="POST" enctype="multipart/form-data" onsubmit="prepareCampaignData()">
    <!-- Hidden field for campaign users data -->
    <input type="hidden" id="campaignUsersData" name="campaign_users_data" value="[]">
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Campaign Details -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Campaign Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Campaign Name *</label>
                        <input type="text" class="form-control" id="name" name="name" required
                               placeholder="e.g., Product Launch Outreach">
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">Message *</label>
                        
                        <!-- Text Formatting Toolbar -->
                        <div class="btn-toolbar mb-2" role="toolbar">
                            <div class="btn-group btn-group-sm me-2" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('b')" title="Bold">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('i')" title="Italic">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('u')" title="Underline">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('s')" title="Strikethrough">
                                    <i class="bi bi-type-strikethrough"></i>
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm me-2" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('code')" title="Code">
                                    <i class="bi bi-code"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('pre')" title="Code Block">
                                    <i class="bi bi-code-square"></i>
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('üòä')" title="Emoji">
                                    üòä
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('üëç')" title="Emoji">
                                    üëç
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('‚ù§Ô∏è')" title="Emoji">
                                    ‚ù§Ô∏è
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('üî•')" title="Emoji">
                                    üî•
                                </button>
                            </div>
                        </div>
                        
                        <textarea class="form-control" id="message" name="message" rows="6"
                                  placeholder="Enter your message (optional if sending media)..."></textarea>
                        <small class="text-muted">Supports Telegram HTML formatting</small>
                    </div>

                    <!-- Media Upload -->
                    <div class="mb-3">
                        <label for="mediaFile" class="form-label">Attach Media (Optional)</label>
                        <input type="file" class="form-control" id="mediaFile" name="media" 
                               accept="image/*,video/*,audio/*" onchange="previewMedia(event)">
                        <small class="text-muted">Supported: Images (jpg, png, gif), Video (mp4), Audio (mp3, ogg)</small>
                        <div id="mediaPreview" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-file-earmark"></i> <span id="mediaFileName"></span>
                                <button type="button" class="btn-close float-end" onclick="clearMedia()"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaign Users -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Campaign Users</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="importCsvButton">
                            <i class="bi bi-upload"></i> Import CSV/XLS
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-plus-circle"></i> Add User
                        </button>
                    </div>
                </div>
                <input type="file" id="csvUpload" accept=".csv,.xlsx,.xls" style="display: none;" >
                
                <!-- Import Status -->
                <div id="importStatus" class="alert alert-info m-3" style="display: none;"></div>
                
                <!-- Filters -->
                <div class="card-body border-bottom">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="filterUsername" placeholder="Search by username..." onkeyup="filterCampaignUsers()">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm" id="filterUserId" placeholder="User ID..." onkeyup="filterCampaignUsers()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filterPriority" onchange="filterCampaignUsers()">
                                <option value="">All Priorities</option>
                                <option value="1">Priority 1</option>
                                <option value="2">Priority 2</option>
                                <option value="3">Priority 3</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-secondary w-100" onclick="clearCampaignFilters()">Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-striped mb-0" id="campaignUsersTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAllUsers" onchange="toggleAllCampaignUsers(this)">
                                    </th>
                                    <th>Username</th>
                                    <th>User ID</th>
                                    <th>Phone</th>
                                    <th>Priority</th>
                                    <th width="60">Action</th>
                                </tr>
                            </thead>
                            <tbody id="campaignUsersBody">
                                <!-- Users will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noUsersMessage" class="p-4 text-center text-muted">
                        <i class="bi bi-people fs-3 d-block mb-2"></i>
                        <p class="mb-0">No users added to this campaign yet.</p>
                        <small>Import users via CSV/Excel files or add manually.</small>
                        <div class="mt-2">
                            <details>
                                <summary class="text-primary" style="cursor: pointer;">CSV Format Help</summary>
                                <div class="mt-2 p-2 bg-light rounded">
                                    <strong>Supported File Formats:</strong>
                                    <pre class="mt-1 mb-1">User name,User ID,Phone number
john_doe,123456789,+1234567890
@jane_smith,987654321,+9876543210
mike_wilson,555444333,+5554443333</pre>
                                    <small class="text-muted">
                                        ‚Ä¢ Column 1: User name (Telegram username, @ optional)
                                        <br>‚Ä¢ Column 2: User ID (numeric Telegram ID)
                                        <br>‚Ä¢ Column 3: Phone number (with + prefix)
                                        <br>‚Ä¢ At least one field (User name, User ID, or Phone) required
                                        <br><strong>Excel Support:</strong>
                                        <br>‚Ä¢ Supports .xlsx, .xls, .xlsm formats
                                        <br>‚Ä¢ Uses first worksheet
                                        <br>‚Ä¢ Same column structure as CSV
                                    </small>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Select Accounts -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Select Accounts</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllAccounts()">
                        Select All
                    </button>
                </div>
                <div class="card-body">
                    {% if accounts %}
                        {% for account in accounts %}
                        <div class="form-check mb-3">
                            <input class="form-check-input account-checkbox" type="checkbox"
                                   name="accounts" value="{{ account.phone }}" id="acc{{ loop.index }}">
                            <label class="form-check-label" for="acc{{ loop.index }}">
                                <div>
                                    <strong>{{ account.phone or 'N/A' }}</strong>
                                    <br>
                                    <small class="text-muted">{{ account.first_name }}</small>
                                    <br>
                                    <span class="badge bg-{{ 'success' if account.status == 'active' else 'warning' }}">
                                        {{ account.status }}
                                    </span>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-person-circle" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">No accounts available</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Summary -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Summary</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Accounts:</dt>
                        <dd class="col-sm-6"><span id="accountCount">0</span> selected</dd>

                        <dt class="col-sm-6">Users:</dt>
                        <dd class="col-sm-6"><span id="userCount">0</span> selected</dd>
                    </dl>

                    <hr>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-rocket-takeoff"></i> Create Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add User to Campaign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="modalUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="modalUsername" placeholder="@username">
                    </div>
                    <div class="mb-3">
                        <label for="modalUserId" class="form-label">User ID</label>
                        <input type="text" class="form-control" id="modalUserId" placeholder="123456789">
                    </div>
                    <div class="mb-3">
                        <label for="modalPhone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="modalPhone" placeholder="+1234567890">
                    </div>
                    <div class="mb-3">
                        <label for="modalPriority" class="form-label">Priority</label>
                        <select class="form-select" id="modalPriority">
                            <option value="1">Priority 1 (High)</option>
                            <option value="2">Priority 2 (Medium)</option>
                            <option value="3">Priority 3 (Low)</option>
                        </select>
                    </div>
                    <small class="text-muted">At least one field (username, user ID, or phone) must be provided.</small>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddUser()">Add User</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
console.log("\nüöÄ ============================================");
console.log("üéØ TELESPAM CAMPAIGN JS v2.0 - BUILD 20241130_141841");
console.log("‚ú® JavaScript successfully loaded and executing!");
console.log("üìÖ Timestamp: " + new Date().toISOString());
console.log("üîÑ If you see this, cache is cleared!");
console.log("============================================\n");
console.log("Campaign JavaScript loaded");
// Check if SheetJS library is loaded
if (typeof XLSX !== "undefined") {
    console.log("‚úÖ SheetJS library loaded successfully");
} else {
    console.error("‚ùå SheetJS library NOT loaded - Excel import will not work");
}

// Check if addCampaignUser function exists
if (typeof addCampaignUser === "function") {
    console.log("‚úÖ addCampaignUser function is available");
} else {
    console.error("‚ùå addCampaignUser function NOT found");
}
function updateCounts() {
    const accountCount = document.querySelectorAll('.account-checkbox:checked').length;
    const userCount = document.querySelectorAll('.user-checkbox:checked').length;

    document.getElementById('accountCount').textContent = accountCount;
    document.getElementById('userCount').textContent = userCount;

}


function selectAllAccounts() {
    const checkboxes = document.querySelectorAll('.account-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateCounts();

}


function selectAllUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateCounts();

}


document.querySelectorAll('.account-checkbox, .user-checkbox').forEach(cb => {
    cb.addEventListener('change', updateCounts);
});

updateCounts();

// CSV Import - REMOVED: This function was for general user import, not campaign-specific
// Campaign users are handled by handleFileImport() below

// Text Formatting
function insertFormat(tag) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let formattedText;
    if (selectedText) {
        // Wrap selected text
        formattedText = `<${tag}>${selectedText}</${tag}>`;
    } else {
        // Insert empty tags
        formattedText = `<${tag}></${tag}>`;
    }
    
    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    
    // Set cursor position
    const cursorPos = start + tag.length + 2 + (selectedText ? selectedText.length : 0);
    textarea.setSelectionRange(cursorPos, cursorPos);
    textarea.focus();

}


function insertEmoji(emoji) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    
    textarea.value = textarea.value.substring(0, start) + emoji + textarea.value.substring(end);
    
    const cursorPos = start + emoji.length;
    textarea.setSelectionRange(cursorPos, cursorPos);
    textarea.focus();

}


// Media Preview
function previewMedia(event) {
    const file = event.target.files[0];
    console.log("Selected file:", file);
    if (file) {
        document.getElementById('mediaFileName').textContent = file.name;
        document.getElementById('mediaPreview').style.display = 'block';
    }

}


function clearMedia() {
    document.getElementById('mediaFile').value = '';
    document.getElementById('mediaPreview').style.display = 'none';

}


// ========================================================================
// CAMPAIGN USERS MANAGEMENT
// ========================================================================

let campaignUsers = []; // Store users for this campaign

function updateUserCount() {
    const count = campaignUsers.length;
    document.getElementById('userCount').textContent = count;
    
    // Show/hide table vs empty message
    const table = document.getElementById('campaignUsersTable').parentElement;
    const message = document.getElementById('noUsersMessage');
    
    if (count > 0) {
        table.style.display = 'block';
        message.style.display = 'none';
    } else {
        table.style.display = 'none';
        message.style.display = 'block';
    }

}


function addCampaignUser(username, user_id, phone, priority = 1) {
    console.log("Adding campaign user:", {username, user_id, phone, priority});
    const user = {
        id: Date.now(), // temporary ID
        username: username,
        user_id: user_id,
        phone: phone,
        priority: priority
    };
    
    campaignUsers.push(user);
    renderCampaignUsers();
    updateUserCount();

}


function removeCampaignUser(tempId) {
    campaignUsers = campaignUsers.filter(user => user.id !== tempId);
    renderCampaignUsers();
    updateUserCount();

}


function renderCampaignUsers() {
    const tbody = document.getElementById('campaignUsersBody');
    tbody.innerHTML = '';
    
    campaignUsers.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input user-checkbox" name="campaign_users" value="${user.id}">
            </td>
            <td>@${user.username || 'N/A'}</td>
            <td>${user.user_id || ''}</td>
            <td>${user.phone || ''}</td>
            <td>
                <span class="badge bg-info">${user.priority}</span>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCampaignUser(${user.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

}


function filterCampaignUsers() {
    const usernameFilter = document.getElementById('filterUsername').value.toLowerCase();
    const userIdFilter = document.getElementById('filterUserId').value.toLowerCase();
    const priorityFilter = document.getElementById('filterPriority').value;
    
    const rows = document.querySelectorAll('#campaignUsersBody tr');
    
    rows.forEach(row => {
        const username = row.cells[1].textContent.toLowerCase();
        const userId = row.cells[2].textContent.toLowerCase();
        const priority = row.cells[3].textContent;
        
        const matchUsername = !usernameFilter || username.includes(usernameFilter);
        const matchUserId = !userIdFilter || userId.includes(userIdFilter);
        const matchPriority = !priorityFilter || priority.includes(priorityFilter);
        
        row.style.display = matchUsername && matchUserId && matchPriority ? '' : 'none';
    });

}


function clearCampaignFilters() {
    document.getElementById('filterUsername').value = '';
    document.getElementById('filterUserId').value = '';
    document.getElementById('filterPriority').value = '';
    filterCampaignUsers();

}


function toggleAllCampaignUsers(checkbox) {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);

}


// Enhanced debugging for handleFileImport
function handleFileImport(event) {
    console.log("=== FILE IMPORT DEBUG START ===");
    console.log("1. Function called, event:", event);
    console.log("1a. Event target:", event.target);
    console.log("1b. Event target files:", event.target.files);
    
    const file = event.target.files[0];
    console.log("2. Selected file:", file);
    
    if (!file) {
        console.log("3. No file selected, exiting");
        alert("No file selected. Please select a CSV or Excel file.");
        return;
    }
    
    console.log("3. File details:", {
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: file.lastModified
    });
    
    const status = document.getElementById('importStatus');
    if (!status) {
        console.error("4. Import status element not found!");
        return;
    }
    
    status.style.display = 'block';
    status.className = 'alert alert-info m-3';
    status.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    const fileName = file.name.toLowerCase();
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.xlsm');
    
    console.log("5. File type detection:", {
        fileName: fileName,
        isExcel: isExcel,
        xlsxLibraryAvailable: typeof XLSX !== 'undefined'
    });
    
    if (isExcel) {
        if (typeof XLSX === 'undefined') {
            console.error("6. XLSX library not loaded! Cannot parse Excel files.");
            status.className = 'alert alert-danger m-3';
            status.innerHTML = '<i class="bi bi-x-circle"></i> Error: Excel library not loaded. Please refresh the page.';
            return;
        }
        
        console.log("6. Processing as Excel file...");
        const reader = new FileReader();
        
        reader.onload = function(e) {
            console.log("7. FileReader onload triggered for Excel");
            try {
                const data = new Uint8Array(e.target.result);
                console.log("8. Data read, size:", data.length);
                
                const workbook = XLSX.read(data, {type: 'array'});
                console.log("9. Workbook parsed, sheets:", workbook.SheetNames);
                
                const wsname = workbook.SheetNames[0];
                const ws = workbook.Sheets[wsname];
                console.log("10. Using worksheet:", wsname);
                
                const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});
                console.log("11. Excel data as JSON:", jsonData);
                
                if (!jsonData || jsonData.length === 0) {
                    console.log("12. No data found in Excel file");
                    status.className = 'alert alert-warning m-3';
                    status.innerHTML = '<i class="bi bi-exclamation-triangle"></i> No data found in file';
                    return;
                }
                
                let imported = 0;
                let skipped = 0;
                
                // Process rows (skip header)
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) {
                        console.log(`13. Row ${i} is empty, skipping`);
                        skipped++;
                        continue;
                    }
                    
                    const username = row[0] ? String(row[0]).trim() : '';
                    const user_id = row[1] ? String(row[1]).trim() : '';
                    const phone = row[2] ? String(row[2]).trim() : '';
                    
                    console.log(`14. Row ${i} data:`, {username, user_id, phone});
                    
                    const cleanUsername = username ? username.replace(/@+/g, '') : '';
                    
                    if (cleanUsername || user_id || phone) {
                        console.log(`15. Adding user from row ${i}`);
                        
                        // Check if addCampaignUser exists
                        if (typeof addCampaignUser === 'function') {
                            addCampaignUser(cleanUsername, user_id, phone, 1);
                            imported++;
                        } else {
                            console.error("16. addCampaignUser function not found!");
                            status.className = 'alert alert-danger m-3';
                            status.innerHTML = '<i class="bi bi-x-circle"></i> Error: User addition function not found';
                            return;
                        }
                    } else {
                        console.log(`17. Row ${i} has no valid data, skipping`);
                        skipped++;
                    }
                }
                
                console.log(`18. Import complete: ${imported} imported, ${skipped} skipped`);
                status.className = 'alert alert-success m-3';
                status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users from Excel! (${skipped} rows skipped)`;
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error('19. Excel processing error:', error);
                status.className = 'alert alert-danger m-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading Excel: ${error.message}`;
            }
        };
        
        reader.onerror = function(error) {
            console.error("20. FileReader error:", error);
            status.className = 'alert alert-danger m-3';
            status.innerHTML = '<i class="bi bi-x-circle"></i> Error reading file';
        };
        
        console.log("21. Starting to read Excel file...");
        reader.readAsArrayBuffer(file);
        
    } else {
        // CSV handling
        console.log("6. Processing as CSV file...");
        const reader = new FileReader();
        
        reader.onload = function(e) {
            console.log("7. FileReader onload triggered for CSV");
            try {
                const text = e.target.result;
                console.log("8. CSV text length:", text.length);
                console.log("9. First 200 chars:", text.substring(0, 200));
                
                const lines = text.split('\n');
                console.log("10. Total lines in CSV:", lines.length);
                
                if (lines.length < 2) {
                    console.log("11. CSV file has no data rows");
                    status.className = 'alert alert-warning m-3';
                    status.innerHTML = '<i class="bi bi-exclamation-triangle"></i> CSV file appears to be empty';
                    return;
                }
                
                console.log("12. CSV Header:", lines[0]);
                
                let imported = 0;
                let skipped = 0;
                
                // Process data rows
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) {
                        console.log(`13. Line ${i} is empty, skipping`);
                        skipped++;
                        continue;
                    }
                    
                    console.log(`14. Processing line ${i}:`, line);
                    
                    const columns = line.split(',').map(col => col.trim());
                    const username = columns[0] || '';
                    const user_id = columns[1] || '';
                    const phone = columns[2] || '';
                    
                    console.log(`15. Line ${i} parsed:`, {username, user_id, phone});
                    
                    const cleanUsername = username ? username.replace(/@+/g, '') : '';
                    
                    if (cleanUsername || user_id || phone) {
                        console.log(`16. Adding user from line ${i}`);
                        
                        if (typeof addCampaignUser === 'function') {
                            addCampaignUser(cleanUsername, user_id, phone, 1);
                            imported++;
                        } else {
                            console.error("17. addCampaignUser function not found!");
                            status.className = 'alert alert-danger m-3';
                            status.innerHTML = '<i class="bi bi-x-circle"></i> Error: User addition function not found';
                            return;
                        }
                    } else {
                        console.log(`18. Line ${i} has no valid data, skipping`);
                        skipped++;
                    }
                }
                
                console.log(`19. Import complete: ${imported} imported, ${skipped} skipped`);
                status.className = 'alert alert-success m-3';
                status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users from CSV! (${skipped} rows skipped)`;
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error('20. CSV processing error:', error);
                status.className = 'alert alert-danger m-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading CSV: ${error.message}`;
            }
        };
        
        reader.onerror = function(error) {
            console.error("21. FileReader error:", error);
            status.className = 'alert alert-danger m-3';
            status.innerHTML = '<i class="bi bi-x-circle"></i> Error reading file';
        };
        
        console.log("22. Starting to read CSV file...");
        reader.readAsText(file);
    }
    
    console.log("=== FILE IMPORT DEBUG END ===");
}

// Make the function globally available for onclick handlers
console.log("handleFileImport function defined and assigned to window");
window.handleFileImport = handleFileImport;

// Trigger file upload dialog - make it globally available
function triggerFileUpload() {
    console.log("üîò Import button clicked!");
    const csvUpload = document.getElementById('csvUpload');
    if (csvUpload) {
        console.log("üìã Triggering file dialog for element:", csvUpload);
        csvUpload.click();
    } else {
        console.error("‚ùå CSV upload element not found when button clicked!");
        alert("Error: File upload element not found. Please refresh the page.");
    }
}

// Make function globally available
window.triggerFileUpload = triggerFileUpload;

// Test function for debugging
window.testFileImportSetup = function() {
    console.log("üß™ Testing file import setup...");
    const csvUpload = document.getElementById("csvUpload");
    const importButton = document.getElementById("importCsvButton");
    
    console.log("CSV Upload element:", csvUpload);
    console.log("Import Button element:", importButton);
    
    if (csvUpload) {
        console.log("CSV Upload has onchange:", csvUpload.onchange !== null);
        console.log("CSV Upload has data-handler-attached:", csvUpload.getAttribute('data-handler-attached'));
    }
    
    if (importButton) {
        console.log("Import Button has onclick:", importButton.onclick !== null);
        console.log("Import Button has data-handler-attached:", importButton.getAttribute('data-handler-attached'));
    }
    
    // Try to trigger button click programmatically
    if (importButton) {
        console.log("üß™ Simulating button click...");
        importButton.click();
    }
};

// Setup file import handler and button - simplified and reliable
function setupFileImportHandler() {
    console.log("üîß Setting up file import handler...");
    
    const csvUpload = document.getElementById("csvUpload");
    const importButton = document.getElementById("importCsvButton");
    
    if (!csvUpload) {
        console.error("‚ùå CSV upload element NOT found!");
        // Try again after a short delay
        setTimeout(setupFileImportHandler, 500);
        return;
    }
    
    if (!importButton) {
        console.error("‚ùå Import button NOT found!");
        // Try again after a short delay
        setTimeout(setupFileImportHandler, 500);
        return;
    }
    
    console.log("‚úÖ Both elements found");
    
    // Setup file input change handler
    console.log("‚úÖ Setting up file input change handler");
    
    // Remove existing handlers by replacing onchange
    csvUpload.onchange = null;
    
    // Add the handler with explicit logging
    csvUpload.addEventListener("change", function(event) {
        console.log("üìÇ File input change event triggered!");
        console.log("üìÇ Event:", event);
        console.log("üìÇ Files:", event.target.files);
        if (event.target.files && event.target.files.length > 0) {
            console.log("üìÇ Processing file:", event.target.files[0].name);
            handleFileImport(event);
        } else {
            console.warn("üìÇ No files in event");
        }
    }, false);
    
    // Also set onchange as backup
    csvUpload.onchange = function(event) {
        console.log("üìÇ File input onchange triggered (backup)!");
        if (event.target.files && event.target.files.length > 0) {
            handleFileImport(event);
        }
    };
    
    console.log("‚úÖ File input handler attached");
    
    // Setup button click handler
    console.log("‚úÖ Setting up button click handler");
    
    // Remove existing handlers
    importButton.onclick = null;
    
    // Add click handler
    importButton.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log("üîò Import button clicked!");
        
        // Get fresh reference to csvUpload element
        const currentCsvUpload = document.getElementById("csvUpload");
        if (currentCsvUpload) {
            console.log("üìã Triggering file dialog...");
            currentCsvUpload.click();
        } else {
            console.error("‚ùå CSV upload element not found when button clicked!");
            alert("Error: File upload element not found. Please refresh the page.");
        }
        return false;
    }, false);
    
    // Also set onclick as backup
    importButton.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log("üîò Import button onclick triggered (backup)!");
        const currentCsvUpload = document.getElementById("csvUpload");
        if (currentCsvUpload) {
            currentCsvUpload.click();
        }
        return false;
    };
    
    // Mark as attached
    csvUpload.setAttribute('data-handler-attached', 'true');
    importButton.setAttribute('data-handler-attached', 'true');
    
    console.log("‚úÖ Button click handler attached successfully");
    console.log("‚úÖ All handlers setup complete");
}

// Setup when DOM is ready - multiple methods for reliability
(function() {
    console.log("üìÑ Initializing file import handlers...");
    console.log("üìÑ Document ready state:", document.readyState);
    
    function init() {
        console.log("üìÑ Running initialization...");
        setupFileImportHandler();
    }
    
    // Method 1: If DOM is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log("üìÑ DOM already ready, initializing immediately");
        setTimeout(init, 100); // Small delay to ensure everything is ready
    } else {
        // Method 2: Wait for DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üìÑ DOMContentLoaded fired, initializing");
            init();
        });
    }
    
    // Method 3: Fallback after window load
    window.addEventListener('load', function() {
        console.log("üìÑ Window load fired, checking handlers...");
        const csvUpload = document.getElementById("csvUpload");
        const importButton = document.getElementById("importCsvButton");
        if (csvUpload && importButton) {
            // Check if handlers are attached
            const hasHandler = csvUpload.onchange !== null || csvUpload.getAttribute('data-handler-attached') === 'true';
            if (!hasHandler) {
                console.log("‚ö†Ô∏è Handlers not attached, retrying...");
                init();
            } else {
                console.log("‚úÖ Handlers already attached");
            }
        }
    });
    
    // Method 4: Final fallback after delay
    setTimeout(function() {
        console.log("‚è±Ô∏è Delayed setup attempt (final fallback)");
        const csvUpload = document.getElementById("csvUpload");
        const importButton = document.getElementById("importCsvButton");
        if (csvUpload && importButton) {
            const hasHandler = csvUpload.onchange !== null || csvUpload.getAttribute('data-handler-attached') === 'true';
            if (!hasHandler) {
                console.log("‚ö†Ô∏è Handlers still not attached, final retry...");
                init();
            }
        }
    }, 2000);
})();



function submitAddUser() {
    const username = document.getElementById('modalUsername').value.trim();
    const user_id = document.getElementById('modalUserId').value.trim();
    const phone = document.getElementById('modalPhone').value.trim();
    const priority = parseInt(document.getElementById('modalPriority').value);
    
    // Validation
    if (!username && !user_id && !phone) {
        alert('Please provide at least one field (username, user ID, or phone)');
        return;
    }
    
    // Clean username
    const cleanUsername = username.replace('@', '');
    
    // Add user
    addCampaignUser(cleanUsername, user_id, phone, priority);
    
    // Clear form
    document.getElementById('addUserForm').reset();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
    modal.hide();

}


function prepareCampaignData() {
    // Serialize campaign users to JSON and set in hidden field
    const jsonData = JSON.stringify(campaignUsers);
    document.getElementById('campaignUsersData').value = jsonData;
    console.log('Prepared campaign data:', jsonData);
    return true; // Allow form submission

}


// Initialize
updateUserCount();
{% endblock %}
