{% extends "base.html" %}

{% block title %}New Campaign - Telegram Outreach{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Create New Campaign</h1>
    <a href="{{ url_for('campaigns') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</div>

<form method="POST" enctype="multipart/form-data" onsubmit="prepareCampaignData()">
    <!-- Hidden field for campaign users data -->
    <input type="hidden" id="campaignUsersData" name="campaign_users_data" value="[]">
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Campaign Details -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Campaign Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Campaign Name *</label>
                        <input type="text" class="form-control" id="name" name="name" required
                               placeholder="e.g., Product Launch Outreach">
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">Message *</label>
                        
                        <!-- Text Formatting Toolbar -->
                        <div class="btn-toolbar mb-2" role="toolbar">
                            <div class="btn-group btn-group-sm me-2" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('b')" title="Bold">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('i')" title="Italic">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('u')" title="Underline">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('s')" title="Strikethrough">
                                    <i class="bi bi-type-strikethrough"></i>
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm me-2" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('code')" title="Code">
                                    <i class="bi bi-code"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertFormat('pre')" title="Code Block">
                                    <i class="bi bi-code-square"></i>
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('üòä')" title="Emoji">
                                    üòä
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('üëç')" title="Emoji">
                                    üëç
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('‚ù§Ô∏è')" title="Emoji">
                                    ‚ù§Ô∏è
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="insertEmoji('üî•')" title="Emoji">
                                    üî•
                                </button>
                            </div>
                        </div>
                        
                        <textarea class="form-control" id="message" name="message" rows="6"
                                  placeholder="Enter your message (optional if sending media)..."></textarea>
                        <small class="text-muted">Supports Telegram HTML formatting</small>
                    </div>

                    <!-- Media Upload -->
                    <div class="mb-3">
                        <label for="mediaFile" class="form-label">Attach Media (Optional)</label>
                        <input type="file" class="form-control" id="mediaFile" name="media" 
                               accept="image/*,video/*,audio/*" onchange="previewMedia(event)">
                        <small class="text-muted">Supported: Images (jpg, png, gif), Video (mp4), Audio (mp3, ogg)</small>
                        <div id="mediaPreview" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-file-earmark"></i> <span id="mediaFileName"></span>
                                <button type="button" class="btn-close float-end" onclick="clearMedia()"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaign Users -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Campaign Users</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="document.getElementById('csvUpload').click()">
                            <i class="bi bi-upload"></i> Import CSV/XLS
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-plus-circle"></i> Add User
                        </button>
                    </div>
                </div>
                <input type="file" id="csvUpload" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">
                
                <!-- Import Status -->
                <div id="importStatus" class="alert alert-info m-3" style="display: none;"></div>
                
                <!-- Filters -->
                <div class="card-body border-bottom">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="filterUsername" placeholder="Search by username..." onkeyup="filterCampaignUsers()">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm" id="filterUserId" placeholder="User ID..." onkeyup="filterCampaignUsers()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filterPriority" onchange="filterCampaignUsers()">
                                <option value="">All Priorities</option>
                                <option value="1">Priority 1</option>
                                <option value="2">Priority 2</option>
                                <option value="3">Priority 3</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-secondary w-100" onclick="clearCampaignFilters()">Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-striped mb-0" id="campaignUsersTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAllUsers" onchange="toggleAllCampaignUsers(this)">
                                    </th>
                                    <th>Username</th>
                                    <th>User ID</th>
                                    <th>Phone</th>
                                    <th>Priority</th>
                                    <th width="60">Action</th>
                                </tr>
                            </thead>
                            <tbody id="campaignUsersBody">
                                <!-- Users will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noUsersMessage" class="p-4 text-center text-muted">
                        <i class="bi bi-people fs-3 d-block mb-2"></i>
                        <p class="mb-0">No users added to this campaign yet.</p>
                        <small>Import users via CSV/Excel files or add manually.</small>
                        <div class="mt-2">
                            <details>
                                <summary class="text-primary" style="cursor: pointer;">CSV Format Help</summary>
                                <div class="mt-2 p-2 bg-light rounded">
                                    <strong>Supported File Formats:</strong>
                                    <pre class="mt-1 mb-1">User name,User ID,Phone number
john_doe,123456789,+1234567890
@jane_smith,987654321,+9876543210
mike_wilson,555444333,+5554443333</pre>
                                    <small class="text-muted">
                                        ‚Ä¢ Column 1: User name (Telegram username, @ optional)
                                        <br>‚Ä¢ Column 2: User ID (numeric Telegram ID)
                                        <br>‚Ä¢ Column 3: Phone number (with + prefix)
                                        <br>‚Ä¢ At least one field (User name, User ID, or Phone) required
                                        <br><strong>Excel Support:</strong>
                                        <br>‚Ä¢ Supports .xlsx, .xls, .xlsm formats
                                        <br>‚Ä¢ Uses first worksheet
                                        <br>‚Ä¢ Same column structure as CSV
                                    </small>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Select Accounts -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Select Accounts</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllAccounts()">
                        Select All
                    </button>
                </div>
                <div class="card-body">
                    {% if accounts %}
                        {% for account in accounts %}
                        <div class="form-check mb-3">
                            <input class="form-check-input account-checkbox" type="checkbox"
                                   name="accounts" value="{{ account.phone }}" id="acc{{ loop.index }}">
                            <label class="form-check-label" for="acc{{ loop.index }}">
                                <div>
                                    <strong>{{ account.phone or 'N/A' }}</strong>
                                    <br>
                                    <small class="text-muted">{{ account.first_name }}</small>
                                    <br>
                                    <span class="badge bg-{{ 'success' if account.status == 'active' else 'warning' }}">
                                        {{ account.status }}
                                    </span>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-person-circle" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">No accounts available</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Summary -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Summary</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Accounts:</dt>
                        <dd class="col-sm-6"><span id="accountCount">0</span> selected</dd>

                        <dt class="col-sm-6">Users:</dt>
                        <dd class="col-sm-6"><span id="userCount">0</span> selected</dd>
                    </dl>

                    <hr>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-rocket-takeoff"></i> Create Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add User to Campaign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="modalUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="modalUsername" placeholder="@username">
                    </div>
                    <div class="mb-3">
                        <label for="modalUserId" class="form-label">User ID</label>
                        <input type="text" class="form-control" id="modalUserId" placeholder="123456789">
                    </div>
                    <div class="mb-3">
                        <label for="modalPhone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="modalPhone" placeholder="+1234567890">
                    </div>
                    <div class="mb-3">
                        <label for="modalPriority" class="form-label">Priority</label>
                        <select class="form-select" id="modalPriority">
                            <option value="1">Priority 1 (High)</option>
                            <option value="2">Priority 2 (Medium)</option>
                            <option value="3">Priority 3 (Low)</option>
                        </select>
                    </div>
                    <small class="text-muted">At least one field (username, user ID, or phone) must be provided.</small>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddUser()">Add User</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function updateCounts() {
    const accountCount = document.querySelectorAll('.account-checkbox:checked').length;
    const userCount = document.querySelectorAll('.user-checkbox:checked').length;

    document.getElementById('accountCount').textContent = accountCount;
    document.getElementById('userCount').textContent = userCount;
}

function selectAllAccounts() {
    const checkboxes = document.querySelectorAll('.account-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateCounts();
}

function selectAllUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateCounts();
}

document.querySelectorAll('.account-checkbox, .user-checkbox').forEach(cb => {
    cb.addEventListener('change', updateCounts);
});

updateCounts();

// CSV Import

// Text Formatting
function insertFormat(tag) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let formattedText;
    if (selectedText) {
        // Wrap selected text
        formattedText = `<${tag}>${selectedText}</${tag}>`;
    } else {
        // Insert empty tags
        formattedText = `<${tag}></${tag}>`;
    }
    
    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    
    // Set cursor position
    const cursorPos = start + tag.length + 2 + (selectedText ? selectedText.length : 0);
    textarea.setSelectionRange(cursorPos, cursorPos);
    textarea.focus();
}

function insertEmoji(emoji) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    
    textarea.value = textarea.value.substring(0, start) + emoji + textarea.value.substring(end);
    
    const cursorPos = start + emoji.length;
    textarea.setSelectionRange(cursorPos, cursorPos);
    textarea.focus();
}

// Media Preview
function previewMedia(event) {
    const file = event.target.files[0];
    console.log("Selected file:", file);
    if (file) {
        document.getElementById('mediaFileName').textContent = file.name;
        document.getElementById('mediaPreview').style.display = 'block';
    }
}

function clearMedia() {
    document.getElementById('mediaFile').value = '';
    document.getElementById('mediaPreview').style.display = 'none';
}

// ========================================================================
// CAMPAIGN USERS MANAGEMENT
// ========================================================================

let campaignUsers = []; // Store users for this campaign

function updateUserCount() {
    const count = campaignUsers.length;
    document.getElementById('userCount').textContent = count;
    
    // Show/hide table vs empty message
    const table = document.getElementById('campaignUsersTable').parentElement;
    const message = document.getElementById('noUsersMessage');
    
    if (count > 0) {
        table.style.display = 'block';
        message.style.display = 'none';
    } else {
        table.style.display = 'none';
        message.style.display = 'block';
    }
}

function addCampaignUser(username, user_id, phone, priority = 1) {
    console.log("Adding campaign user:", {username, user_id, phone, priority});
    const user = {
        id: Date.now(), // temporary ID
        username: username,
        user_id: user_id,
        phone: phone,
        priority: priority
    };
    
    campaignUsers.push(user);
    renderCampaignUsers();
    updateUserCount();
}

function removeCampaignUser(tempId) {
    campaignUsers = campaignUsers.filter(user => user.id !== tempId);
    renderCampaignUsers();
    updateUserCount();
}

function renderCampaignUsers() {
    const tbody = document.getElementById('campaignUsersBody');
    tbody.innerHTML = '';
    
    campaignUsers.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input user-checkbox" name="campaign_users" value="${user.id}">
            </td>
            <td>@${user.username || 'N/A'}</td>
            <td>${user.user_id || ''}</td>
            <td>${user.phone || ''}</td>
            <td>
                <span class="badge bg-info">${user.priority}</span>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCampaignUser(${user.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function filterCampaignUsers() {
    const usernameFilter = document.getElementById('filterUsername').value.toLowerCase();
    const userIdFilter = document.getElementById('filterUserId').value.toLowerCase();
    const priorityFilter = document.getElementById('filterPriority').value;
    
    const rows = document.querySelectorAll('#campaignUsersBody tr');
    
    rows.forEach(row => {
        const username = row.cells[1].textContent.toLowerCase();
        const userId = row.cells[2].textContent.toLowerCase();
        const priority = row.cells[3].textContent;
        
        const matchUsername = !usernameFilter || username.includes(usernameFilter);
        const matchUserId = !userIdFilter || userId.includes(userIdFilter);
        const matchPriority = !priorityFilter || priority.includes(priorityFilter);
        
        row.style.display = matchUsername && matchUserId && matchPriority ? '' : 'none';
    });
}

function clearCampaignFilters() {
    document.getElementById('filterUsername').value = '';
    document.getElementById('filterUserId').value = '';
    document.getElementById('filterPriority').value = '';
    filterCampaignUsers();
}

function toggleAllCampaignUsers(checkbox) {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function handleFileImport(event) {
    console.log("File upload function called", event);
    const file = event.target.files[0];
    console.log("Selected file:", file);
    if (!file) return;
    
    const status = document.getElementById('importStatus');
    status.style.display = 'block';
    status.className = 'alert alert-info m-3';
    status.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    const fileName = file.name.toLowerCase();
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
    
    if (isExcel) {
        // Handle Excel files using SheetJS
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                console.log("Reading Excel file...");
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Get first worksheet
                const wsname = workbook.SheetNames[0];
                const ws = workbook.Sheets[wsname];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});
                console.log("Excel data:", jsonData);
                
                let imported = 0;
                
                // Skip header row (expecting: User name, User ID, Phone number)
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                    
                    const username = row[0] ? String(row[0]).trim() : '';
                    const user_id = row[1] ? String(row[1]).trim() : '';
                    const phone = row[2] ? String(row[2]).trim() : '';
                    
                    console.log('Processing Excel row:', {username, user_id, phone});
                    
                    // Clean username (remove @ if present)
                    const cleanUsername = username ? username.replace(/@+/g, '') : '';
                    
                    if (cleanUsername || user_id || phone) {
                        addCampaignUser(cleanUsername, user_id, phone, 1);
                        imported++;
                    }
                }
                
                status.className = 'alert alert-success m-3';
                status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users from Excel successfully!`;
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Excel processing error:', error);
                status.className = 'alert alert-danger m-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading Excel file: ${error.message}`;
            }
        };
        
        reader.onerror = function(error) {
            console.error("FileReader error:", error);
            status.className = 'alert alert-danger m-3';
            status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading Excel file: ${error}`;
        };
        
        console.log("FileReader started for Excel");
        reader.readAsArrayBuffer(file);
        
    } else {
        // Handle CSV files
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                console.log("Reading CSV file...");
                const lines = e.target.result.split('\n');
                let imported = 0;
                
                // Skip header line (expecting: User name, User ID, Phone number)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const columns = line.split(',');
                    const username = columns[0]?.trim(); // User name
                    const user_id = columns[1]?.trim(); // User ID
                    const phone = columns[2]?.trim(); // Phone number
                    
                    console.log('Processing CSV row:', {username, user_id, phone});
                    
                    // Clean username (remove @ if present)
                    const cleanUsername = username ? username.replace(/@+/g, '') : '';
                    
                    if (cleanUsername || user_id || phone) {
                        addCampaignUser(cleanUsername, user_id, phone, 1);
                        imported++;
                    }
                }
                
                status.className = 'alert alert-success m-3';
                status.innerHTML = `<i class="bi bi-check-circle"></i> Imported ${imported} users from CSV successfully!`;
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('CSV processing error:', error);
                status.className = 'alert alert-danger m-3';
                status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading CSV file: ${error.message}`;
            }
        };
        
        reader.onerror = function(error) {
            console.error("FileReader error:", error);
            status.className = 'alert alert-danger m-3';
            status.innerHTML = `<i class="bi bi-x-circle"></i> Error reading CSV file: ${error}`;
        };
        
        console.log("FileReader started for CSV");
        reader.readAsText(file);
    }
}

function submitAddUser() {
    const username = document.getElementById('modalUsername').value.trim();
    const user_id = document.getElementById('modalUserId').value.trim();
    const phone = document.getElementById('modalPhone').value.trim();
    const priority = parseInt(document.getElementById('modalPriority').value);
    
    // Validation
    if (!username && !user_id && !phone) {
        alert('Please provide at least one field (username, user ID, or phone)');
        return;
    }
    
    // Clean username
    const cleanUsername = username.replace('@', '');
    
    // Add user
    addCampaignUser(cleanUsername, user_id, phone, priority);
    
    // Clear form
    document.getElementById('addUserForm').reset();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
    modal.hide();
}

function prepareCampaignData() {
    // Serialize campaign users to JSON and set in hidden field
    const jsonData = JSON.stringify(campaignUsers);
    document.getElementById('campaignUsersData').value = jsonData;
    console.log('Prepared campaign data:', jsonData);
    return true; // Allow form submission
}

// Initialize
updateUserCount();
{% endblock %}
