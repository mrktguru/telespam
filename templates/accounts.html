{% extends "base.html" %}

{% block title %}Accounts - Telegram Outreach{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Telegram Accounts</h1>
    <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addAccountModal">
            <i class="bi bi-plus-circle"></i> Add Account
        </button>
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#helpModal">
            <i class="bi bi-info-circle"></i> Help
        </button>
    </div>
</div>

{% if accounts %}
<p class="text-muted mb-3"><strong>Total accounts: {{ accounts|length }}</strong></p>
<div class="row g-3">
    {% for account in accounts %}
    <div class="col-md-6 col-lg-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1">{{ account.phone or 'N/A' }}</h5>
                        <p class="text-muted mb-0">{{ account.first_name }} {{ account.last_name or '' }}</p>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-{{ 'success' if account.status == 'active' else 'warning' if account.status == 'warming' else 'danger' if account.status == 'unauthorized' else 'secondary' }} mb-2">
                            {{ account.status }}
                        </span>
                        <!-- Profile Photo Preview -->
                        <div class="profile-photo-preview" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #dee2e6; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                            {% if account.photo_count and account.photo_count > 0 %}
                                <img src="{{ url_for('get_account_profile_photo', account_id=account.id) }}" 
                                     alt="Profile Photo" 
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; color: #6c757d;">
                                    <i class="bi bi-person-circle" style="font-size: 30px;"></i>
                                </div>
                            {% else %}
                                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                                    <i class="bi bi-person-circle" style="font-size: 30px;"></i>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if account.username %}
                <p class="mb-2">
                    <i class="bi bi-at"></i> @{{ account.username }}
                </p>
                {% endif %}

                <p class="mb-2">
                    <i class="bi bi-hash"></i> {{ account.id }}
                </p>

                {% if account.campaign_id %}
                <p class="mb-2">
                    <i class="bi bi-megaphone"></i> Campaign: 
                    <span class="badge bg-primary">#{{ account.campaign_id }}</span>
                </p>
                {% endif %}

                <hr>

                <div class="row text-center small">
                    <div class="col-6">
                        <div class="text-muted">Sent Today</div>
                        <strong>{{ account.daily_sent or 0 }}</strong>
                    </div>
                    <div class="col-6">
                        <div class="text-muted">Total Sent</div>
                        <strong>{{ account.total_sent or 0 }}</strong>
                    </div>
                </div>

                {% if account.rate_limits %}
                <hr>
                <div class="small">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Hour limit:</span>
                        <span>
                            {% if account.rate_limits.limits.per_hour %}
                                {{ account.rate_limits.sent_hour }}/{{ account.rate_limits.limits.per_hour }}
                            {% else %}
                                Unlimited
                            {% endif %}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Day limit:</span>
                        <span>
                            {% if account.rate_limits.limits.per_day %}
                                {{ account.rate_limits.sent_day }}/{{ account.rate_limits.limits.per_day }}
                            {% else %}
                                Unlimited
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endif %}

                {% if account.use_proxy %}
                <hr>
                <div class="small">
                    <i class="bi bi-shield-lock text-success"></i> Proxy enabled
                </div>
                {% endif %}
            </div>
            <div class="card-footer d-flex justify-content-between">
                <a href="{{ url_for('edit_account', account_id=account.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit Profile
                </a>
                <form action="{{ url_for('delete_account', account_id=account.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete account {{ account.phone }}? This action cannot be undone.');" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-person-circle" style="font-size: 4rem; color: #dee2e6;"></i>
        <h4 class="mt-3 mb-2">No accounts added yet</h4>
        <p class="text-muted mb-4">Add Telegram accounts using CLI to start sending messages</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#helpModal">
            <i class="bi bi-question-circle"></i> How to add accounts
        </button>
    </div>
</div>
{% endif %}

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Telegram Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="addAccountTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tdata-tab" data-bs-toggle="tab" data-bs-target="#tdata" type="button" role="tab" style="color: #495057;">
                            <i class="bi bi-file-zip"></i> TDATA/SESSION/JSON
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" style="color: #495057;">
                            <i class="bi bi-phone"></i> Manual (Phone + API)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="authkey-tab" data-bs-toggle="tab" data-bs-target="#authkey" type="button" role="tab" style="color: #495057;">
                            <i class="bi bi-key"></i> AUTH KEY
                        </button>
                    </li>
                </ul>
                
                <style>
                .nav-tabs .nav-link {
                    color: #495057 !important;
                }
                .nav-tabs .nav-link.active {
                    color: #0d6efd !important;
                    font-weight: 500;
                }
                .nav-tabs .nav-link:hover {
                    color: #0d6efd !important;
                }
                </style>
                
                <div class="tab-content" id="addAccountTabContent">
                    <!-- TDATA/SESSION/JSON Tab -->
                    <div class="tab-pane fade show active" id="tdata" role="tabpanel">
                        <form id="addAccountTdataForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="tdataFile" class="form-label">Upload TDATA ZIP, SESSION file, or JSON credentials</label>
                                <input type="file" class="form-control" id="tdataFile" name="file" accept=".zip,.session,.json">
                                <div class="form-text">
                                    Supported formats:
                                    <ul class="mb-0 mt-1">
                                        <li><strong>TDATA:</strong> ZIP archive or folder with tdata</li>
                                        <li><strong>SESSION:</strong> .session file from Telethon</li>
                                        <li><strong>JSON:</strong> Credentials file with phone, api_id, api_hash</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="tdataNotes" class="form-label">Notes (optional)</label>
                                <input type="text" class="form-control" id="tdataNotes" name="notes" placeholder="e.g., Main account">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload"></i> Upload and Add Account
                            </button>
                        </form>
                    </div>
                    
                    <!-- Manual Tab -->
                    <div class="tab-pane fade" id="manual" role="tabpanel">
                        <form id="addAccountManualForm">
                            <div class="mb-3">
                                <label for="manualPhone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="manualPhone" name="phone" placeholder="+79991234567" required>
                                <div class="form-text">Include country code (e.g., +7 for Russia, +1 for USA)</div>
                            </div>
                            <div class="mb-3">
                                <label for="manualApiId" class="form-label">API ID <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="manualApiId" name="api_id" placeholder="12345678" required>
                                <div class="form-text">Get from <a href="https://my.telegram.org" target="_blank">my.telegram.org</a> â†’ API development tools</div>
                            </div>
                            <div class="mb-3">
                                <label for="manualApiHash" class="form-label">API Hash <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="manualApiHash" name="api_hash" placeholder="abc123def456..." required>
                                <div class="form-text">32 characters, get from my.telegram.org</div>
                            </div>
                            <div class="mb-3">
                                <label for="manualPassword" class="form-label">2FA Password (optional)</label>
                                <input type="password" class="form-control" id="manualPassword" name="password" placeholder="Leave empty if no 2FA">
                                <div class="form-text">Required only if account has 2FA enabled</div>
                            </div>
                            <div class="mb-3">
                                <label for="manualNotes" class="form-label">Notes (optional)</label>
                                <input type="text" class="form-control" id="manualNotes" name="notes" placeholder="e.g., Main account">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-plus"></i> Add Account
                            </button>
                        </form>
                    </div>
                    
                    <!-- AUTH KEY Tab -->
                    <div class="tab-pane fade" id="authkey" role="tabpanel">
                        <form id="addAccountAuthKeyForm">
                            <div class="mb-3">
                                <label for="authKeyPhone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="authKeyPhone" name="phone" placeholder="+79991234567" required>
                                <div class="form-text">Include country code</div>
                            </div>
                            <div class="mb-3">
                                <label for="authKeyValue" class="form-label">AUTH KEY (hex) <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="authKeyValue" name="auth_key" rows="3" placeholder="a1b2c3d4e5f6..." required></textarea>
                                <div class="form-text">256 hex characters (128 bytes). Extract from Telegram Desktop session</div>
                            </div>
                            <div class="mb-3">
                                <label for="authKeyDcId" class="form-label">DC ID <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="authKeyDcId" name="dc_id" placeholder="2" min="1" max="5" required>
                                <div class="form-text">Data center ID (1-5). Usually 2 for most users</div>
                            </div>
                            <div class="mb-3">
                                <label for="authKeyUserId" class="form-label">User ID (optional)</label>
                                <input type="number" class="form-control" id="authKeyUserId" name="user_id" placeholder="123456789">
                                <div class="form-text">Your Telegram user ID (optional, will be fetched if not provided)</div>
                            </div>
                            <div class="mb-3">
                                <label for="authKeyNotes" class="form-label">Notes (optional)</label>
                                <input type="text" class="form-control" id="authKeyNotes" name="notes" placeholder="e.g., Main account">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-key"></i> Add Account
                            </button>
                        </form>
                    </div>
                </div>
                
                <div id="addAccountAlert" class="alert d-none mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">How to Add Accounts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You can add accounts directly from this page using the "Add Account" button, or use the CLI interface:</p>

                <h6 class="mt-3">Option 1: TDATA/SESSION/JSON</h6>
                <p class="mb-2">Upload a file containing account data:</p>
                <ul>
                    <li><strong>TDATA:</strong> ZIP archive or folder from Telegram Desktop</li>
                    <li><strong>SESSION:</strong> .session file from Telethon</li>
                    <li><strong>JSON:</strong> Credentials file with phone, api_id, api_hash</li>
                </ul>

                <h6 class="mt-3">Option 2: Manual (Phone + API)</h6>
                <p class="mb-2">Enter phone number and API credentials from <a href="https://my.telegram.org" target="_blank">my.telegram.org</a></p>

                <h6 class="mt-3">Option 3: AUTH KEY</h6>
                <p class="mb-2">Use AUTH KEY and DC ID extracted from Telegram Desktop session</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Handle TDATA/SESSION/JSON form
document.getElementById('addAccountTdataForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const alertDiv = document.getElementById('addAccountAlert');
    
    try {
        const response = await fetch('{{ url_for("add_account_tdata") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alertDiv.className = 'alert alert-success mt-3';
            alertDiv.textContent = 'Account added successfully! Page will reload...';
            alertDiv.classList.remove('d-none');
            setTimeout(() => location.reload(), 2000);
        } else {
            alertDiv.className = 'alert alert-danger mt-3';
            alertDiv.textContent = 'Error: ' + (result.error || 'Failed to add account');
            alertDiv.classList.remove('d-none');
        }
    } catch (error) {
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.textContent = 'Error: ' + error.message;
        alertDiv.classList.remove('d-none');
    }
});

// Handle Manual form
document.getElementById('addAccountManualForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const alertDiv = document.getElementById('addAccountAlert');
    
    try {
        const response = await fetch('{{ url_for("add_account_manual") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alertDiv.className = 'alert alert-success mt-3';
            alertDiv.textContent = 'Account added successfully! Page will reload...';
            alertDiv.classList.remove('d-none');
            setTimeout(() => location.reload(), 2000);
        } else {
            alertDiv.className = 'alert alert-danger mt-3';
            alertDiv.textContent = 'Error: ' + (result.error || 'Failed to add account');
            alertDiv.classList.remove('d-none');
        }
    } catch (error) {
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.textContent = 'Error: ' + error.message;
        alertDiv.classList.remove('d-none');
    }
});

// Handle AUTH KEY form
document.getElementById('addAccountAuthKeyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const alertDiv = document.getElementById('addAccountAlert');
    
    try {
        const response = await fetch('{{ url_for("add_account_authkey") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alertDiv.className = 'alert alert-success mt-3';
            alertDiv.textContent = 'Account added successfully! Page will reload...';
            alertDiv.classList.remove('d-none');
            setTimeout(() => location.reload(), 2000);
        } else {
            alertDiv.className = 'alert alert-danger mt-3';
            alertDiv.textContent = 'Error: ' + (result.error || 'Failed to add account');
            alertDiv.classList.remove('d-none');
        }
    } catch (error) {
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.textContent = 'Error: ' + error.message;
        alertDiv.classList.remove('d-none');
    }
});
</script>
{% endblock %}
{% endblock %}
