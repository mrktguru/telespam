#!/bin/bash
# –ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite

set -e

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DB_PATH="${PROJECT_DIR}/telespam.db"
DB_DIR="$(dirname "$DB_PATH")"

echo "=========================================="
echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
echo "=========================================="
echo ""
echo "üìÅ –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: $DB_PATH"
echo "üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $DB_DIR"
echo ""

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "$DB_DIR" ]; then
    echo "üìÅ –°–æ–∑–¥–∞—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $DB_DIR"
    mkdir -p "$DB_DIR"
fi

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –ë–î –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "$DB_PATH" ]; then
    echo "üìÑ –°–æ–∑–¥–∞—é —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: $DB_PATH"
    touch "$DB_PATH"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞
echo "–¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞:"
ls -la "$DB_PATH" 2>/dev/null || echo "‚ö†Ô∏è  –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
echo ""

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
chmod 755 "$DB_DIR" 2>/dev/null || {
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è sudo)"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 755 $DB_DIR"
}

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª –ë–î –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (WAL, SHM)
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
chmod 664 "$DB_PATH" 2>/dev/null || {
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è sudo)"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 664 $DB_PATH"
}

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ WAL –∏ SHM —Ñ–∞–π–ª—ã (SQLite WAL mode)
if [ -f "${DB_PATH}-wal" ]; then
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ WAL —Ñ–∞–π–ª..."
    chmod 664 "${DB_PATH}-wal" 2>/dev/null || {
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ WAL —Ñ–∞–π–ª"
        echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 664 ${DB_PATH}-wal"
    }
fi

if [ -f "${DB_PATH}-shm" ]; then
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ SHM —Ñ–∞–π–ª..."
    chmod 664 "${DB_PATH}-shm" 2>/dev/null || {
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ SHM —Ñ–∞–π–ª"
        echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 664 ${DB_PATH}-shm"
    }
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
echo "üîç –û–ø—Ä–µ–¥–µ–ª—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."
GUNICORN_USER=""

# –ú–µ—Ç–æ–¥ 1: –ò–∑ systemd service
if [ -z "$GUNICORN_USER" ]; then
    SYSTEMD_USER=$(systemctl show -p User telespam-web.service 2>/dev/null | cut -d= -f2 || echo "")
    if [ -n "$SYSTEMD_USER" ] && [ "$SYSTEMD_USER" != "" ]; then
        GUNICORN_USER="$SYSTEMD_USER"
        echo "   ‚úì –ù–∞–π–¥–µ–Ω –≤ systemd service: $GUNICORN_USER"
    fi
fi

# –ú–µ—Ç–æ–¥ 2: –ò–∑ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ gunicorn
if [ -z "$GUNICORN_USER" ]; then
    RUNNING_USER=$(ps aux | grep -E '[g]unicorn.*web_app:app' | head -1 | awk '{print $1}' || echo "")
    if [ -n "$RUNNING_USER" ] && [ "$RUNNING_USER" != "" ]; then
        GUNICORN_USER="$RUNNING_USER"
        echo "   ‚úì –ù–∞–π–¥–µ–Ω –≤ –∑–∞–ø—É—â–µ–Ω–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ: $GUNICORN_USER"
    fi
fi

# –ú–µ—Ç–æ–¥ 3: –ò–∑ –ª—é–±–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ gunicorn
if [ -z "$GUNICORN_USER" ]; then
    ANY_GUNICORN=$(ps aux | grep -E '[g]unicorn' | head -1 | awk '{print $1}' || echo "")
    if [ -n "$ANY_GUNICORN" ] && [ "$ANY_GUNICORN" != "" ]; then
        GUNICORN_USER="$ANY_GUNICORN"
        echo "   ‚úì –ù–∞–π–¥–µ–Ω –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ gunicorn: $GUNICORN_USER"
    fi
fi

# –ú–µ—Ç–æ–¥ 4: Fallback - —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ —Å sudo)
if [ -z "$GUNICORN_USER" ]; then
    if [ -n "$SUDO_USER" ]; then
        GUNICORN_USER="$SUDO_USER"
        echo "   ‚ö† –ò—Å–ø–æ–ª—å–∑—É—é SUDO_USER: $GUNICORN_USER"
    else
        GUNICORN_USER=$(whoami)
        echo "   ‚ö† –ò—Å–ø–æ–ª—å–∑—É—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $GUNICORN_USER"
    fi
fi

echo "   üë§ –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $GUNICORN_USER"
echo ""

# –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –æ—Ç root –∏–ª–∏ —Å sudo, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
if [ "$EUID" -eq 0 ] || [ -n "$SUDO_USER" ]; then
    if [ -n "$GUNICORN_USER" ]; then
        echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤: $GUNICORN_USER"
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        if chown "$GUNICORN_USER:$GUNICORN_USER" "$DB_PATH" 2>/dev/null; then
            echo "   ‚úì –í–ª–∞–¥–µ–ª–µ—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        else
            echo "   ‚úó –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
        fi
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        if chown "$GUNICORN_USER:$GUNICORN_USER" "$DB_DIR" 2>/dev/null; then
            echo "   ‚úì –í–ª–∞–¥–µ–ª–µ—Ü –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        else
            echo "   ‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
        fi
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è WAL –∏ SHM —Ñ–∞–π–ª–æ–≤
        if [ -f "${DB_PATH}-wal" ]; then
            if chown "$GUNICORN_USER:$GUNICORN_USER" "${DB_PATH}-wal" 2>/dev/null; then
                echo "   ‚úì –í–ª–∞–¥–µ–ª–µ—Ü WAL —Ñ–∞–π–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            else
                echo "   ‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ WAL —Ñ–∞–π–ª–∞"
            fi
        fi
        
        if [ -f "${DB_PATH}-shm" ]; then
            if chown "$GUNICORN_USER:$GUNICORN_USER" "${DB_PATH}-shm" 2>/dev/null; then
                echo "   ‚úì –í–ª–∞–¥–µ–ª–µ—Ü SHM —Ñ–∞–π–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            else
                echo "   ‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ SHM —Ñ–∞–π–ª–∞"
            fi
        fi
    else
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
    fi
else
    echo "‚ÑπÔ∏è  –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–µ –æ—Ç root, –ø—Ä–æ–ø—É—Å–∫–∞—é —É—Å—Ç–∞–Ω–æ–≤–∫—É –≤–ª–∞–¥–µ–ª—å—Ü–∞"
    echo "   –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: sudo bash $0"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "‚úÖ –ù–æ–≤—ã–µ –ø—Ä–∞–≤–∞:"
ls -la "$DB_PATH"
if [ -f "${DB_PATH}-wal" ]; then
    ls -la "${DB_PATH}-wal"
fi
if [ -f "${DB_PATH}-shm" ]; then
    ls -la "${DB_PATH}-shm"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ -r "$DB_PATH" ] && [ -w "$DB_PATH" ]; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏"
else
    echo "‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å sudo: sudo bash $0"
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
echo ""
echo "üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
echo "   –ü—É—Ç—å –∫ –ë–î: $DB_PATH"
echo "   –í–ª–∞–¥–µ–ª–µ—Ü –ë–î: $(stat -c '%U:%G' "$DB_PATH" 2>/dev/null || stat -f '%Su:%Sg' "$DB_PATH" 2>/dev/null || echo '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')"
echo "   –ü—Ä–∞–≤–∞ –ë–î: $(stat -c '%a' "$DB_PATH" 2>/dev/null || stat -f '%A' "$DB_PATH" 2>/dev/null || echo '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')"
echo "   –í–ª–∞–¥–µ–ª–µ—Ü –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $(stat -c '%U:%G' "$DB_DIR" 2>/dev/null || stat -f '%Su:%Sg' "$DB_DIR" 2>/dev/null || echo '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')"
echo "   –ü—Ä–∞–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $(stat -c '%a' "$DB_DIR" 2>/dev/null || stat -f '%A' "$DB_DIR" 2>/dev/null || echo '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –ø–∏—Å–∞—Ç—å
if [ -n "$GUNICORN_USER" ]; then
    echo "   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞: $GUNICORN_USER"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—Å–∞—Ç—å (–µ—Å–ª–∏ –º—ã root)
    if [ "$EUID" -eq 0 ]; then
        if sudo -u "$GUNICORN_USER" test -w "$DB_PATH" 2>/dev/null; then
            echo "   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $GUNICORN_USER –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –ë–î"
        else
            echo "   ‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $GUNICORN_USER –ù–ï –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –ë–î"
            echo "      –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chown -R $GUNICORN_USER:$GUNICORN_USER $DB_DIR"
        fi
    fi
fi

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
echo ""
echo "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo "   1. –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª: ls -la $DB_PATH"
echo "   2. –ü—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ls -la $DB_DIR"
echo "   3. –í–ª–∞–¥–µ–ª–µ—Ü —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
echo ""

