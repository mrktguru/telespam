#!/bin/bash
# –ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite

set -e

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DB_PATH="${PROJECT_DIR}/telespam.db"
DB_DIR="$(dirname "$DB_PATH")"

echo "=========================================="
echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
echo "=========================================="
echo ""
echo "üìÅ –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: $DB_PATH"
echo "üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $DB_DIR"
echo ""

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "$DB_DIR" ]; then
    echo "üìÅ –°–æ–∑–¥–∞—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $DB_DIR"
    mkdir -p "$DB_DIR"
fi

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –ë–î –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "$DB_PATH" ]; then
    echo "üìÑ –°–æ–∑–¥–∞—é —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: $DB_PATH"
    touch "$DB_PATH"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞
echo "–¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞:"
ls -la "$DB_PATH" 2>/dev/null || echo "‚ö†Ô∏è  –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
echo ""

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
chmod 755 "$DB_DIR" 2>/dev/null || {
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è sudo)"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 755 $DB_DIR"
}

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª –ë–î –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (WAL, SHM)
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
chmod 664 "$DB_PATH" 2>/dev/null || {
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è sudo)"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 664 $DB_PATH"
}

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ WAL –∏ SHM —Ñ–∞–π–ª—ã (SQLite WAL mode)
if [ -f "${DB_PATH}-wal" ]; then
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ WAL —Ñ–∞–π–ª..."
    chmod 664 "${DB_PATH}-wal" 2>/dev/null || {
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ WAL —Ñ–∞–π–ª"
        echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 664 ${DB_PATH}-wal"
    }
fi

if [ -f "${DB_PATH}-shm" ]; then
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –Ω–∞ SHM —Ñ–∞–π–ª..."
    chmod 664 "${DB_PATH}-shm" 2>/dev/null || {
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ SHM —Ñ–∞–π–ª"
        echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: sudo chmod 664 ${DB_PATH}-shm"
    }
fi

# –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –æ—Ç root –∏–ª–∏ —Å sudo, —Ç–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
if [ "$EUID" -eq 0 ] || [ -n "$SUDO_USER" ]; then
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è gunicorn –∏–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    GUNICORN_USER=$(systemctl show -p User telespam-web.service 2>/dev/null | cut -d= -f2 || echo "")
    
    if [ -z "$GUNICORN_USER" ]; then
        GUNICORN_USER=$(ps aux | grep -E 'gunicorn|flask' | grep -v grep | head -1 | awk '{print $1}' || echo "")
    fi
    
    if [ -z "$GUNICORN_USER" ] && [ -n "$SUDO_USER" ]; then
        GUNICORN_USER="$SUDO_USER"
    fi
    
    if [ -n "$GUNICORN_USER" ]; then
        echo "üë§ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤–ª–∞–¥–µ–ª—å—Ü–∞: $GUNICORN_USER"
        chown "$GUNICORN_USER:$GUNICORN_USER" "$DB_PATH" 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞"
        chown "$GUNICORN_USER:$GUNICORN_USER" "$DB_DIR" 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
        # –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è WAL –∏ SHM —Ñ–∞–π–ª–æ–≤
        if [ -f "${DB_PATH}-wal" ]; then
            chown "$GUNICORN_USER:$GUNICORN_USER" "${DB_PATH}-wal" 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ WAL —Ñ–∞–π–ª–∞"
        fi
        if [ -f "${DB_PATH}-shm" ]; then
            chown "$GUNICORN_USER:$GUNICORN_USER" "${DB_PATH}-shm" 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ SHM —Ñ–∞–π–ª–∞"
        fi
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "‚úÖ –ù–æ–≤—ã–µ –ø—Ä–∞–≤–∞:"
ls -la "$DB_PATH"
if [ -f "${DB_PATH}-wal" ]; then
    ls -la "${DB_PATH}-wal"
fi
if [ -f "${DB_PATH}-shm" ]; then
    ls -la "${DB_PATH}-shm"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
if [ -r "$DB_PATH" ] && [ -w "$DB_PATH" ]; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏"
else
    echo "‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å sudo: sudo bash $0"
fi

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
echo ""
echo "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo "   1. –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª: ls -la $DB_PATH"
echo "   2. –ü—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ls -la $DB_DIR"
echo "   3. –í–ª–∞–¥–µ–ª–µ—Ü —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
echo ""

