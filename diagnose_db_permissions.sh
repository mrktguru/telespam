#!/bin/bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

echo "=========================================="
echo "–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–ê –ö –ë–ê–ó–ï –î–ê–ù–ù–´–•"
echo "=========================================="
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DB_PATH="${PROJECT_DIR}/telespam.db"
DB_DIR="$(dirname "$DB_PATH")"

echo "üìÅ –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: $DB_PATH"
echo "üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $DB_DIR"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
echo "1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤:"
if [ -f "$DB_PATH" ]; then
    echo "   ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    ls -la "$DB_PATH"
else
    echo "   ‚úó –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

if [ -f "${DB_PATH}-wal" ]; then
    echo "   ‚úÖ WAL —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    ls -la "${DB_PATH}-wal"
else
    echo "   ‚ÑπÔ∏è  WAL —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –ë–î –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)"
fi

if [ -f "${DB_PATH}-shm" ]; then
    echo "   ‚úÖ SHM —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    ls -la "${DB_PATH}-shm"
else
    echo "   ‚ÑπÔ∏è  SHM —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –ë–î –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)"
fi
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "2Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:"
if [ -r "$DB_PATH" ]; then
    echo "   ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è"
else
    echo "   ‚úó –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è"
fi

if [ -w "$DB_PATH" ]; then
    echo "   ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
else
    echo "   ‚úó –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
fi

if [ -x "$DB_DIR" ]; then
    echo "   ‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ–∏—Å–∫–∞)"
else
    echo "   ‚úó –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ù–ï –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"
fi
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
echo "3Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞:"
DB_OWNER=$(stat -c '%U:%G' "$DB_PATH" 2>/dev/null || stat -f '%Su:%Sg' "$DB_PATH" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
DB_PERMS=$(stat -c '%a' "$DB_PATH" 2>/dev/null || stat -f '%A' "$DB_PATH" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
DIR_OWNER=$(stat -c '%U:%G' "$DB_DIR" 2>/dev/null || stat -f '%Su:%Sg' "$DB_DIR" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
DIR_PERMS=$(stat -c '%a' "$DB_DIR" 2>/dev/null || stat -f '%A' "$DB_DIR" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")

echo "   –í–ª–∞–¥–µ–ª–µ—Ü –ë–î: $DB_OWNER"
echo "   –ü—Ä–∞–≤–∞ –ë–î: $DB_PERMS"
echo "   –í–ª–∞–¥–µ–ª–µ—Ü –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $DIR_OWNER"
echo "   –ü—Ä–∞–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $DIR_PERMS"
echo ""

# 4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
echo "4Ô∏è‚É£  –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:"
GUNICORN_USER=""

# –ò–∑ systemd
SYSTEMD_USER=$(systemctl show -p User telespam-web.service 2>/dev/null | cut -d= -f2 || echo "")
if [ -n "$SYSTEMD_USER" ]; then
    echo "   systemd service: $SYSTEMD_USER"
    GUNICORN_USER="$SYSTEMD_USER"
fi

# –ò–∑ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
RUNNING_USER=$(ps aux | grep -E '[g]unicorn.*web_app:app' | head -1 | awk '{print $1}' || echo "")
if [ -n "$RUNNING_USER" ]; then
    echo "   –ó–∞–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å: $RUNNING_USER"
    if [ -z "$GUNICORN_USER" ]; then
        GUNICORN_USER="$RUNNING_USER"
    fi
fi

if [ -z "$GUNICORN_USER" ]; then
    echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
else
    echo "   üë§ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $GUNICORN_USER"
fi
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
echo "5Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞:"
if [ -n "$GUNICORN_USER" ]; then
    DB_OWNER_USER=$(echo "$DB_OWNER" | cut -d: -f1)
    if [ "$DB_OWNER_USER" = "$GUNICORN_USER" ]; then
        echo "   ‚úÖ –í–ª–∞–¥–µ–ª–µ—Ü –ë–î —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
    else
        echo "   ‚úó –í–ª–∞–¥–µ–ª–µ—Ü –ë–î ($DB_OWNER_USER) –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ ($GUNICORN_USER)"
        echo "      –†–µ—à–µ–Ω–∏–µ: sudo chown $GUNICORN_USER:$GUNICORN_USER $DB_PATH"
    fi
else
    echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)"
fi
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "6Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"
if [ -f "$DB_PATH" ]; then
    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–∏—Å–∏
    if python3 -c "import sqlite3; conn = sqlite3.connect('$DB_PATH'); conn.execute('CREATE TABLE IF NOT EXISTS _test_permissions (id INTEGER)'); conn.execute('DROP TABLE _test_permissions'); conn.close()" 2>&1; then
        echo "   ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ (—Ç–µ—Å—Ç –ø—Ä–æ—à–µ–ª)"
    else
        ERROR=$(python3 -c "import sqlite3; conn = sqlite3.connect('$DB_PATH'); conn.execute('CREATE TABLE IF NOT EXISTS _test_permissions (id INTEGER)'); conn.execute('DROP TABLE _test_permissions'); conn.close()" 2>&1)
        echo "   ‚úó –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
        echo "      –û—à–∏–±–∫–∞: $ERROR"
    fi
else
    echo "   ‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç"
fi
echo ""

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –ë–î
echo "7Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –ë–î:"
LSOF_OUTPUT=$(lsof "$DB_PATH" 2>/dev/null || echo "")
if [ -n "$LSOF_OUTPUT" ]; then
    echo "   ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –ë–î:"
    echo "$LSOF_OUTPUT" | while read line; do
        echo "      $line"
    done
else
    echo "   ‚úÖ –ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –ë–î (–∏–ª–∏ lsof –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"
fi
echo ""

# 8. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo "8Ô∏è‚É£  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
if [ ! -w "$DB_PATH" ]; then
    echo "   ‚úó –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
    echo "      –†–µ—à–µ–Ω–∏–µ: sudo chmod 664 $DB_PATH"
fi

if [ -n "$GUNICORN_USER" ]; then
    DB_OWNER_USER=$(echo "$DB_OWNER" | cut -d: -f1)
    if [ "$DB_OWNER_USER" != "$GUNICORN_USER" ]; then
        echo "   ‚úó –í–ª–∞–¥–µ–ª–µ—Ü –ë–î –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
        echo "      –†–µ—à–µ–Ω–∏–µ: sudo chown -R $GUNICORN_USER:$GUNICORN_USER $DB_DIR"
    fi
fi

if [ ! -x "$DB_DIR" ]; then
    echo "   ‚úó –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"
    echo "      –†–µ—à–µ–Ω–∏–µ: sudo chmod 755 $DB_DIR"
fi

echo ""
echo "=========================================="
echo "–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo "  sudo bash fix_db_permissions_simple.sh"
echo "=========================================="

