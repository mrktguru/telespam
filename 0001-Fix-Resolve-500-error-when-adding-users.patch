From 5020a5cfbd4a0d060b9cd22ff83670f2d38da794 Mon Sep 17 00:00:00 2001
From: mrktguru <gommeux@gmail.com>
Date: Sat, 29 Nov 2025 18:17:00 +0000
Subject: [PATCH] Fix: Resolve 500 error when adding users

- Add missing add_user() and get_all_users() methods to MockSheetsManager
- Add proper validation in /users/add endpoint
- Fix ValueError when user_id field is empty
- Replace direct access to sheets_manager.users with get_all_users()
- Add comprehensive error handling with user-friendly messages
- Add test script to verify the fix

This fixes the 500 Internal Server Error that occurred when trying to add users through the web interface.
---
 mock_sheets.py       | 16 ++++++++++
 test_add_user_fix.py | 73 ++++++++++++++++++++++++++++++++++++++++++++
 web_app.py           | 57 ++++++++++++++++++++++------------
 3 files changed, 127 insertions(+), 19 deletions(-)
 create mode 100644 test_add_user_fix.py

diff --git a/mock_sheets.py b/mock_sheets.py
index 32da05e..5531e87 100644
--- a/mock_sheets.py
+++ b/mock_sheets.py
@@ -179,6 +179,22 @@ class MockSheetsManager:
 
     # Users operations
 
+    def add_user(self, user: Dict) -> bool:
+        """Add new user for outreach"""
+        # Add timestamp
+        user['added_at'] = datetime.now().isoformat()
+        user['contacted_at'] = None
+        user['assigned_account'] = None
+        
+        self.users.append(user)
+        self._save_to_file()
+        print(f"✓ User added: {user.get('username') or user.get('user_id')} - priority={user.get('priority')}")
+        return True
+
+    def get_all_users(self) -> List[Dict]:
+        """Get all users"""
+        return self.users
+
     def get_pending_users(self, limit: int = 10) -> List[Dict]:
         """Get users with status 'pending'"""
         pending = [u for u in self.users if u.get('status') == 'pending']
diff --git a/test_add_user_fix.py b/test_add_user_fix.py
new file mode 100644
index 0000000..bf788d6
--- /dev/null
+++ b/test_add_user_fix.py
@@ -0,0 +1,73 @@
+#!/usr/bin/env python3
+"""
+Test script for add_user fix
+"""
+
+import os
+os.environ['USE_MOCK_STORAGE'] = 'true'
+
+from mock_sheets import sheets_manager
+
+print("\n" + "="*70)
+print("  TESTING ADD_USER FIX")
+print("="*70)
+print()
+
+# Test 1: Add user with username only
+print("Test 1: Add user with username only")
+user1 = {
+    'username': 'testuser1',
+    'user_id': None,
+    'phone': None,
+    'priority': 1,
+    'status': 'pending'
+}
+result = sheets_manager.add_user(user1)
+print(f"Result: {'✓ PASS' if result else '✗ FAIL'}")
+print()
+
+# Test 2: Add user with user_id only
+print("Test 2: Add user with user_id only")
+user2 = {
+    'username': None,
+    'user_id': 123456789,
+    'phone': None,
+    'priority': 2,
+    'status': 'pending'
+}
+result = sheets_manager.add_user(user2)
+print(f"Result: {'✓ PASS' if result else '✗ FAIL'}")
+print()
+
+# Test 3: Add user with all fields
+print("Test 3: Add user with all fields")
+user3 = {
+    'username': 'testuser3',
+    'user_id': 987654321,
+    'phone': '+1234567890',
+    'priority': 3,
+    'status': 'pending'
+}
+result = sheets_manager.add_user(user3)
+print(f"Result: {'✓ PASS' if result else '✗ FAIL'}")
+print()
+
+# Test 4: Verify get_all_users works
+print("Test 4: Get all users")
+all_users = sheets_manager.get_all_users()
+print(f"Total users: {len(all_users)}")
+print(f"Result: {'✓ PASS' if len(all_users) >= 3 else '✗ FAIL'}")
+print()
+
+# Display all users
+print("="*70)
+print("  ALL USERS IN SYSTEM")
+print("="*70)
+for i, user in enumerate(all_users, 1):
+    print(f"{i}. username={user.get('username')}, user_id={user.get('user_id')}, priority={user.get('priority')}")
+
+print()
+print("="*70)
+print("  ALL TESTS COMPLETED")
+print("="*70)
+print()
diff --git a/web_app.py b/web_app.py
index 331836c..c92cd88 100755
--- a/web_app.py
+++ b/web_app.py
@@ -110,7 +110,7 @@ def dashboard():
     accounts = sheets_manager.get_all_accounts()
 
     # Get users for outreach
-    users = sheets_manager.users
+    users = sheets_manager.get_all_users()
 
     # Get recent campaigns
     campaigns = db.get_user_campaigns(user_id, limit=10)
@@ -176,7 +176,7 @@ def new_campaign():
 
     # Get accounts and users for form
     accounts = sheets_manager.get_all_accounts()
-    users = sheets_manager.users
+    users = sheets_manager.get_all_users()
 
     return render_template('new_campaign.html', accounts=accounts, users=users)
 
@@ -261,7 +261,7 @@ def accounts_list():
 @login_required
 def users_list():
     """List all users for outreach"""
-    users = sheets_manager.users
+    users = sheets_manager.get_all_users()
 
     return render_template('users.html', users=users)
 
@@ -270,23 +270,42 @@ def users_list():
 @login_required
 def add_user():
     """Add user for outreach"""
-    username = request.form.get('username')
-    user_id = request.form.get('user_id')
-    phone = request.form.get('phone')
-    priority = int(request.form.get('priority', 1))
-
-    user_data = {
-        'username': username,
-        'user_id': int(user_id) if user_id else None,
-        'phone': phone,
-        'priority': priority,
-        'status': 'pending'
-    }
+    try:
+        username = request.form.get('username', '').strip()
+        user_id = request.form.get('user_id', '').strip()
+        phone = request.form.get('phone', '').strip()
+        priority = int(request.form.get('priority', 1))
+
+        # Validate: at least username or user_id must be provided
+        if not username and not user_id:
+            flash('Please provide at least Username or User ID', 'danger')
+            return redirect(url_for('users_list'))
+
+        # Convert user_id to int if provided
+        user_id_int = None
+        if user_id:
+            try:
+                user_id_int = int(user_id)
+            except ValueError:
+                flash('User ID must be a valid number', 'danger')
+                return redirect(url_for('users_list'))
+
+        user_data = {
+            'username': username if username else None,
+            'user_id': user_id_int,
+            'phone': phone if phone else None,
+            'priority': priority,
+            'status': 'pending'
+        }
 
-    sheets_manager.add_user(user_data)
+        sheets_manager.add_user(user_data)
 
-    flash('User added successfully', 'success')
-    return redirect(url_for('users_list'))
+        flash('User added successfully', 'success')
+        return redirect(url_for('users_list'))
+        
+    except Exception as e:
+        flash(f'Error adding user: {str(e)}', 'danger')
+        return redirect(url_for('users_list'))
 
 
 # ============================================================================
@@ -351,7 +370,7 @@ def add_proxy():
 def api_stats():
     """Get system stats (JSON)"""
     accounts = sheets_manager.get_all_accounts()
-    users = sheets_manager.users
+    users = sheets_manager.get_all_users()
     user_id = session['user_id']
     campaigns = db.get_user_campaigns(user_id)
 
-- 
2.44.0

